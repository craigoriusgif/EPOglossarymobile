<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EPO Glossary</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        :root {
            --primary-bg: #f4f4f9;
            --card-bg: #ffffff;
            --border-color: #eee;
            --accent-green: #28a745;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: var(--primary-bg);
            color: #333;
        }

        #csv-upload-section, #search-interface {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            display: block; /* Explicitly visible */
        }

        #search-interface { display: none; min-height: 0; } /* Fixed min-height for iOS */

        .header-with-logo {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        .logo-img { height: 45px; width: auto; border-radius: 4px; }

        /* The Download Button - Fixed for iPad Standalone Mode */
        .download-btn { 
            -webkit-appearance: none; /* Critical for iOS */
            background-color: var(--accent-green) !important; 
            color: white !important; 
            border: none; 
            font-weight: bold; 
            margin: 15px 0; 
            width: 100%; 
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px; 
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-ui, input[type="search"] {
            height: 44px;
            padding: 0 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            background-color: #fff;
        }

        /* Fixed Mobile Card View Logic */
        @media screen and (max-width: 768px) {
            .list-table thead { display: none; }
            .list-table tr { display: block; border: 1px solid #ddd; margin-bottom: 15px; border-radius: 8px; padding: 10px; background: #fff; }
            .list-table td { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
            .list-table td::before { content: attr(data-label); font-weight: bold; color: #666; }
            .list-table td.definition.empty-data { display: none !important; }
        }

        .hidden-col { display: none !important; }
    </style>
</head>
<body>

    <div id="csv-upload-section">
        <h1>EPO Glossary</h1>
        <p>Select a CSV file to load:</p>
        <input type="file" id="csv-file-input" accept=".csv">
    </div>

    <div id="search-interface">
        <div class="header-with-logo">
            <div class="header-left">
                <img src="logo.jpg" alt="Logo" class="logo-img">
                <h2 style="margin:0; display:inline; vertical-align:middle; margin-left:10px;">EPO Glossary</h2>
            </div>
            <button class="btn-ui" onclick="location.reload()">â†» Load New</button>
        </div>

        <button id="download-csv-btn" class="download-btn">ðŸ“¥ Download Filtered Results (CSV)</button>

        <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
            <input type="search" id="search-input" placeholder="Search..." style="flex-grow:1;">
            <button id="clear-search-btn" class="btn-ui">Clear</button>
        </div>

        <div id="my-list">
            <table class="list-table" style="width:100%;">
                <thead>
                    <tr>
                        <th class="sort col-en" data-sort="en">EN</th>
                        <th class="sort col-de" data-sort="de">DE</th>
                        <th class="sort col-fr" data-sort="fr">FR</th>
                        <th class="sort col-definition" data-sort="definition">Definition</th>
                        <th class="sort col-category" data-sort="category">Category</th>
                    </tr>
                </thead>
                <tbody class="list"></tbody>
            </table>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('csv-file-input');
        const uploadSection = document.getElementById('csv-upload-section');
        const searchInterface = document.getElementById('search-interface');
        const searchInput = document.getElementById('search-input');
        let myList;

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                encoding: "UTF-8", // Fix for "Ã©" and special characters
                complete: (results) => {
                    processData(results.data);
                }
            });
        });

        function processData(data) {
            const filteredData = data.filter(i => i.EN || i.en);
            
            myList = new List('my-list', {
                valueNames: ['en', 'de', 'fr', 'definition', 'category'],
                item: `<tr>
                    <td class="en col-en" data-label="EN"></td>
                    <td class="de col-de" data-label="DE"></td>
                    <td class="fr col-fr" data-label="FR"></td>
                    <td class="definition col-definition" data-label="Definition"></td>
                    <td class="category col-category" data-label="Category"></td>
                </tr>`
            }, filteredData);

            // Hide Definition if empty in Mobile Card View
            myList.on('updated', () => {
                document.querySelectorAll('.list tr').forEach(row => {
                    const defCell = row.querySelector('.definition');
                    if (defCell && (!defCell.textContent || defCell.textContent.trim() === "")) {
                        defCell.classList.add('empty-data');
                    } else {
                        defCell.classList.remove('empty-data');
                    }
                });
            });

            uploadSection.style.display = 'none';
            searchInterface.style.display = 'block';
        }

        // Search logic
        searchInput.addEventListener('input', () => myList.search(searchInput.value));
        document.getElementById('clear-search-btn').onclick = () => {
            searchInput.value = '';
            myList.search('');
        };

        // Export logic
        document.getElementById('download-csv-btn').onclick = function() {
            const csv = Papa.unparse(myList.visibleItems.map(i => i.values()));
            const blob = new Blob(["\ufeff", csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "epo_glossary_filtered.csv";
            a.click();
            setTimeout(() => URL.revokeObjectURL(url), 100);
        };
    </script>
</body>
</html>